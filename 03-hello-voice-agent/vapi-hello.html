<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VAPI Voice Agent</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f172a; color: #e2e8f0;
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; min-height: 100vh; padding: 2rem;
    }
    h1 { font-size: 1.5rem; margin-bottom: 0.5rem; }
    .subtitle { color: #94a3b8; margin-bottom: 2rem; font-size: 0.9rem; }
    #call-btn {
      width: 120px; height: 120px; border-radius: 50%; border: none;
      background: #3b82f6; color: white; font-size: 1.1rem; font-weight: 600;
      cursor: pointer; transition: all 0.2s; box-shadow: 0 0 0 0 rgba(59,130,246,0.5);
    }
    #call-btn:hover { background: #2563eb; transform: scale(1.05); }
    #call-btn.active {
      background: #ef4444; animation: pulse 1.5s infinite;
    }
    #call-btn.active:hover { background: #dc2626; }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(239,68,68,0.5); }
      70% { box-shadow: 0 0 0 20px rgba(239,68,68,0); }
      100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); }
    }
    #status { margin-top: 1.5rem; color: #94a3b8; font-size: 0.85rem; }
    #transcript {
      margin-top: 1.5rem; max-width: 500px; width: 100%;
      max-height: 300px; overflow-y: auto; font-size: 0.85rem;
      background: #1e293b; border-radius: 8px; padding: 1rem;
    }
    .msg { margin-bottom: 0.5rem; }
    .msg .role { font-weight: 600; text-transform: capitalize; }
    .msg.user .role { color: #60a5fa; }
    .msg.assistant .role { color: #34d399; }
  </style>
</head>
<body>
  <h1>VAPI Voice Agent</h1>
  <p class="subtitle">Assistant: $assistant_name ($assistant_id)</p>
  <button id="call-btn" onclick="toggleCall()">Start Call</button>
  <div id="status">Click to start a voice call</div>
  <div id="transcript"></div>

  <script src="https://cdn.jsdelivr.net/gh/VapiAI/html-script-tag@latest/dist/assets/index.js" defer></script>
  <script>
    const PUBLIC_KEY = "$public_key";
    const ASSISTANT_ID = "$assistant_id";
    let vapi = null;
    let callActive = false;

    function initVapi() {
      if (vapi) return;
      vapi = window.vapiSDK.run({
        apiKey: PUBLIC_KEY,
        assistant: ASSISTANT_ID,
        config: { hide: true },
      });
      vapi.on('call-start', () => {
        callActive = true;
        document.getElementById('call-btn').classList.add('active');
        document.getElementById('call-btn').textContent = 'End Call';
        document.getElementById('status').textContent = 'Connected — speak now!';
      });
      vapi.on('call-end', () => {
        callActive = false;
        document.getElementById('call-btn').classList.remove('active');
        document.getElementById('call-btn').textContent = 'Start Call';
        document.getElementById('status').textContent = 'Call ended';
      });
      vapi.on('message', (msg) => {
        if (msg.type === 'transcript' && msg.transcriptType === 'final') {
          const div = document.createElement('div');
          div.className = 'msg ' + msg.role;
          div.innerHTML = '<span class="role">' + msg.role + ':</span> ' + msg.transcript;
          document.getElementById('transcript').appendChild(div);
          document.getElementById('transcript').scrollTop = 999999;
        }
      });
      vapi.on('error', (e) => {
        document.getElementById('status').textContent = 'Error: ' + (e.message || e);
      });
    }

    function toggleCall() {
      if (!vapi) {
        initVapi();
        document.getElementById('status').textContent = 'Connecting …';
        return;
      }
      if (callActive) {
        vapi.stop();
      } else {
        vapi.start(ASSISTANT_ID);
        document.getElementById('status').textContent = 'Connecting …';
      }
    }
  </script>
</body>
</html>
